name: PyPI Release (cecli + aider-ce)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  publish_cecli:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.x

    - name: Rename pyproject.toml for cecli build
      run: |
        # Backup original pyproject.toml if it exists
        if [ -f "pyproject.toml" ]; then
          mv pyproject.toml pyproject.toml.backup
        fi
        # Copy cecli.pyproject.toml to pyproject.toml
        cp cecli.pyproject.toml pyproject.toml

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools wheel twine importlib-metadata==7.2.1

    - name: Build and publish cecli
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        python -m build
        twine upload dist/*

    - name: Restore original pyproject.toml
      run: |
        # Restore original pyproject.toml if it was backed up
        if [ -f "pyproject.toml.backup" ]; then
          mv pyproject.toml.backup pyproject.toml
        fi

  publish_aider_ce:
    runs-on: ubuntu-latest
    needs: publish_cecli
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.x

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools wheel twine importlib-metadata==7.2.1

    - name: Build and publish aider-ce (shim package)
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        python -m build
        twine upload dist/*
